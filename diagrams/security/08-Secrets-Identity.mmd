graph TD
  subgraph AzureAD[Microsoft Entra ID]
    AppID["Managed Identity (AKS)"]
    PodID[Pega Pod Workload Identity]
  end

  subgraph AKSCluster[AKS Cluster]
    Pod[Pega Web/Batch Pod]
    CSI[Secrets Store CSI Driver]
    TokenIssuer[OIDC Issuer]
  end

  subgraph KeyVault[Azure Key Vault]
    Secret[Secrets, Certificates]
    Policy[Access Policy RBAC]
  end

  subgraph GitOps[Helm GitOps]
    Chart[Helm Chart values]
    SecretRef[SecretProviderClass]
  end

  Chart --> SecretRef
  SecretRef --> CSI

  Pod -->|requests token| TokenIssuer
  TokenIssuer -->|federated credential| AzureAD
  AzureAD -->|issues access token| PodID
  PodID --> Pod

  Pod -->|mount secrets| CSI
  CSI -->|managed identity| AppID
  AppID --> KeyVault
  KeyVault -->|returns| Secret
  Secret --> CSI
  CSI --> Pod

  style Pod fill:#dbeafe,stroke:#1d4ed8
  style KeyVault fill:#ede9fe,stroke:#6b21a8
  style AzureAD fill:#fef3c7,stroke:#d97706
